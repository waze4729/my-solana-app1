<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Token Scanner</title>
  <!-- (STYLE: Use your previous CSS; omitted here for brevity) -->
  <style>
    /* ... (KEEP YOUR EXISTING CSS) ... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Solana Token Scanner</h1>
      <p>Monitor token holder activity in real-time with live USD valuations</p>
    </header>
    <div class="scan-info">
      <div class="info-item">Polling: <strong id="pollInterval">1 second</strong></div>
      <div class="info-item">Token: <strong id="currentToken">-</strong></div>
    </div>
    <div class="price-info" id="priceInfoRow">
      <!-- Prices will be rendered here -->
    </div>
    <div class="controls">
      <input type="text" id="mint" placeholder="Enter token mint address (SOL/JUP supported)">
      <button class="btn-start" id="startBtn">Start Scan</button>
      <button class="btn-stop" id="stopBtn" disabled>Stop Scan</button>
    </div>
    <div class="status stopped" id="status">
      Not scanning. Enter a token mint address and click Start Scan.
    </div>
    <div class="dashboard" id="dashboard">
      <!-- ... (KEEP YOUR DASHBOARD HTML) ... -->
    </div>
    <div class="top-holders-card" id="topHoldersCard">
      <!-- ... (KEEP YOUR HOLDERS HTML) ... -->
    </div>
    <div class="last-updated" id="lastUpdated">
      Last updated: -
    </div>
  </div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io();
    let currentWatched = [];
    let scanning = false;
    let startTime = null;

    function renderPrices(prices, watchedTokens) {
      const priceInfoRow = document.getElementById("priceInfoRow");
      priceInfoRow.innerHTML = "";
      watchedTokens.forEach(mint => {
        let symbol = "Token";
        if (mint === "So11111111111111111111111111111111111111112") symbol = "SOL";
        else if (mint === "JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN") symbol = "JUP";
        else symbol = mint.substring(0, 4) + "..." + mint.substring(mint.length - 4);
        const price = prices[mint] ? Number(prices[mint]).toFixed(6) : "0.000000";
        const el = document.createElement("div");
        el.className = "price-item";
        el.innerHTML = `
          <span class="token-symbol" data-mint="${mint}" style="cursor:pointer;">${symbol}:</span>
          <span class="price-value">${price}$</span>
        `;
        // Clicking the symbol scans the token
        el.querySelector(".token-symbol").onclick = () => scanToken(mint);
        priceInfoRow.appendChild(el);
      });
      // Last updated
      const updated = document.createElement("div");
      updated.className = "price-item";
      updated.innerHTML = `<span>Last Updated:</span> <span id="priceUpdated">${prices.lastUpdated ? new Date(prices.lastUpdated).toLocaleTimeString() : "-"}</span>`;
      priceInfoRow.appendChild(updated);
    }
    function scanToken(mint) {
      document.getElementById("mint").value = mint;
      startScan();
    }
    function startScan() {
      const mint = document.getElementById("mint").value.trim();
      if (!mint) { alert('Please enter a token mint address'); return; }
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('status').textContent = 'Starting scan...';
      document.getElementById('status').className = 'status scanning';
      document.getElementById('currentToken').textContent = mint.substring(0, 8) + '...' + mint.substring(mint.length - 6);
      scanning = true;
      socket.emit("startScan", mint);
    }
    function stopScan() {
      socket.emit("stopScan");
      document.getElementById('status').textContent = 'Scan stopped - Ready for new scan';
      document.getElementById('status').className = 'status stopped';
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      scanning = false;
    }

    // Button events
    document.getElementById('startBtn').onclick = startScan;
    document.getElementById('stopBtn').onclick = stopScan;

    // SOCKET EVENTS
    socket.on("watchedTokens", mints => {
      currentWatched = mints;
    });
    socket.on("priceUpdate", (prices) => {
      renderPrices(prices, currentWatched);
    });
    socket.on("statusUpdate", (data) => {
      // You can use your previous `updateDisplay(data)` here
      // For demonstration, we update some fields:
      if(data.startTime) startTime = new Date(data.startTime);
      document.getElementById('startedAt').textContent = startTime ? startTime.toLocaleString() : '-';
      // ... (Handle other dashboard fields as per your code)
      document.getElementById('status').textContent = scanning
        ? "Scanning active - Real-time monitoring"
        : "Scan stopped - Ready for new scan";
    });

    // Add token to watch on click from elsewhere
    // Example: document.querySelector('.myToken').onclick = () => socket.emit("watchToken", mint);

    // Initial load
    fetch("/api/status")
      .then(resp => resp.json())
      .then(data => {
        currentWatched = data.watchedTokens || [];
        renderPrices(data.prices || {}, currentWatched);
      });
  </script>
</body>
</html>
